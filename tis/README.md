# First try

The idea here is to use the S2OPC repository as the root of the analysis.
A `tis` branch is created to add the files needed to do the analysis.
Except the `tis.config` file that must be at the root of the repository,
all the other files and directories should be in in a `tis` directory,
in particular the dependencies that are added there as sub-modules.

## S2OPC repository

Let's first get the sources from the upstream repository,
and fork it home:

```
$ git clone https://gitlab.com/systerel/S2OPC.git --branch S2OPC_Toolkit_1.0.0
$ cd S2OPC
$ git remote rename origin upstream
$ git remote add origin ssh://git@git.trust-in-soft.com:7999/use/s2opc.git
$ git checkout -b master
$ git push -u origin master
```

Now create our `tis` branch and the `tis` directory:

```
$ git checkout -b tis
$ git push -u origin tis
$ mkdir tis
$ cd tis

# Edit this README.md file here
$ git add README.md

$ PREFIX=$PWD/prefix
```

## Install dependencies

The `PREFIX` directory defined above is used as the local installation
directory.
Since S2OPC uses Cmake, it seems easier (mandatory?) to also use Cmake to
compile the dependencies.
Moreover,`CMAKE_EXPORT_COMPILE_COMMANDS` can then be used.

Note: `cmake -LH ..` can be useful to get the configurable variables.

For each dependency `lib`:

- `lib` is added as a sub-module and the requested branch is selected
- a `build_lib` directory is created for the compilation process
- in `build_lib`, `cmake` is called to build the `compile_commands.json`
(and all the other files generated by `cmake`)
- `make` is called to compile
- `make install` installs every thing in `$PREFIX`
- `tis-prepare` is used to build the symbol table and clean everything.

After that, the sub-module should be clean
(this can be checked with `cd lib ; git clean -nxd`).


### libcheck

```
$ cd $PREFIX/..
$ git submodule add https://github.com/libcheck/check.git
$ cd check ; git checkout 0.14.0 ; cd ..
$ git add check
$ mkdir build_libcheck && cd build_libcheck
$ cmake ../check -DCMAKE_EXPORT_COMPILE_COMMANDS=On \
                 -DCMAKE_INSTALL_PREFIX=$PREFIX
$ make && make install
$ tis-prepare all-symbol-table -- -64 -cpp-tool gcc
$ tis-prepare clean
```

```
[INFO] Summary: 30+15/45 (100%) [OK+CACHED]   0/45 (0%) [SKIPPED]   0/45 (0%) [FAIL]
```

### mbedtls

```
$ cd $PREFIX/..
$ git submodule add https://github.com/ARMmbed/mbedtls.git
$ cd mbedtls ; git checkout mbedtls-2.12.0 ; cd ..
$ git add mbedtls
$ mkdir build_mbedtls && cd build_mbedtls
$ cmake ../mbedtls -DCMAKE_EXPORT_COMPILE_COMMANDS=On \
                   -DCMAKE_INSTALL_PREFIX=$PREFIX
$ make && make install
$ tis-prepare all-symbol-table -- -64 -cpp-tool gcc
$ tis-prepare clean
```

```
[INFO] Summary: 197+0/197 (100%) [OK+CACHED]   0/197 (0%) [SKIPPED]   0/197 (0%) [FAIL]
```

### libexpat

```
$ cd $PREFIX/..
$ git submodule add https://github.com/libexpat/libexpat.git
$ cd libexpat ; git checkout R_2_2_9 ; cd ..
$ git add libexpat
$ mkdir build_expat && cd build_expat
$ cmake ../libexpat/expat -DCMAKE_EXPORT_COMPILE_COMMANDS=On \
                          -DCMAKE_INSTALL_PREFIX=$PREFIX \
                          -DEXPAT_WITH_SYS_GETRANDOM=Off \
                          -DEXPAT_BUILD_TESTS=Off
$ make && make install
$ tis-prepare all-symbol-table -- -64 -cpp-tool gcc
$ tis-prepare clean
```

```
[INFO] Summary: 1+8/9 (100%) [OK+CACHED]   0/9 (0%) [SKIPPED]   0/9 (0%) [FAIL]
```

## S2OPC compilation

Now that all the dependencies are installed,
S2OPC can be compiled, and its symbol table generated.

```
$ cd $PREFIX/..
$ mkdir build_s2opc && cd build_s2opc
$ cmake ../.. -DCMAKE_EXPORT_COMPILE_COMMANDS=On \
              -DCMAKE_INSTALL_PREFIX=$PREFIX \
              -DCMAKE_PREFIX_PATH=$PREFIX
$ make
$ tis-prepare all-symbol-table -- -64 -cpp-tool gcc
$ tis-prepare clean
```

```
[INFO] Summary: 280+63/345 (99%) [OK+CACHED]   0/345 (0%) [SKIPPED]   2/345 (0%) [FAIL]
```

## S2OPC test configuration

A `tis.config` file is created at the root of the repository
because this is mandatory, but it includes other configuration files
from the `tis` directory:

```
[
  { "name": "check_helpers", "include": "tis/check_helpers.config_generated" },
  ...
]
```


### check_helpers

This first test is selected to start with
because it probably does not request a complex analysis.

To generate the configuration for this test:
```
$ cd $PREFIX/..
$ tis-prepare tis-config check_helpers.config -- --interpreter
```
with `check_helpers.config`:
```
{
  "files": [ "../tests/ClientServer/unit_tests/helpers/check_helpers.c" ],
  "compilation_database": [
    "build_s2opc", "build_mbedtls", "build_expat", "build_libcheck"
  ]
}
```

It stops on:
```
check/src/check_list.c:71:[value] warning: invalid pointer {{ &__malloc_emalloc_l62_12 + {4} }}.
(...)
[FAIL] Successfully completed 0/1 configs in check_helpers.config_generated.
```

Indeed, there is a call to `memmove (p,q,0);` with `p` past-one
that has to be fixed.

