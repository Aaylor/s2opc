/*
 * Licensed to Systerel under one or more contributor license
 * agreements. See the NOTICE file distributed with this work
 * for additional information regarding copyright ownership.
 * Systerel licenses this file to you under the Apache
 * License, Version 2.0 (the "License"); you may not use this
 * file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

#include "check_helpers.h"

#include <check.h>
#include <stdlib.h>

#include "hexlify.h"
#include "sopc_key_manager.h"

// server_2k.der
static const char* CRT_URI =
    "3082042930820311a003020102020106300d06092a864886f70d01010b0500308188310b3009060355040613024652"
    "310c300a06035504080c03494446310e300c06035504070c0550415249533110300e060355040a0c07494e474f5043"
    "533110300e060355040b0c07494e474f5043533113301106035504030c0a494e474f5043532043413122302006092a"
    "864886f70d0109011613696e676f70637340737973746572656c2e6672301e170d3137313130323136353835345a17"
    "0d3138313130323136353835345a3068310b3009060355040613024652310c300a06035504080c03494446310e300c"
    "06035504070c0550415249533110300e060355040a0c07494e474f5043533110300e060355040b0c07494e474f5043"
    "533117301506035504030c0e494e474f5043532053455256455230820122300d06092a864886f70d01010105000382"
    "010f003082010a0282010100b245842f18a25870b4bdcf162ca5b2d48cb531f0c5ba5d509e5051b892fe535d6dbfba"
    "fc6f3e430af250468659476cfd8381c57a9dc4063d14ef48b6ede87b1a15e3560a8a759a4cda397a71034c812142c7"
    "43d16685b6fe2f2bb3a56570a88f87452121ecb6bce7865e14ef83a5bd436661995a8a0635d3ba9b22324bd2d06f3c"
    "f117418d6e9e2fa3e1d317c77ba00972e622d602d8f1c07a720ba7d064150ee0533f256ccc0bb6fa0447dcacc97462"
    "7c54bb544c60cbef5aeb70ebfe8c07acaf64f315088e8461a4af2f9d8846065c416d0c1cc4075e4baa2d7f44c1be2b"
    "d1e2d8dec1f9796b8727cac05f5e931069192fae496298a549bae6df699e2638270203010001a381bc3081b9301d06"
    "03551d0e0416041449da0583068c3c894ac32777d92ba84e8763f722301f0603551d2304183016801431ae8e653364"
    "06e4379b518fc3379dce459bb61f300f0603551d130101ff040530030101ff300b0603551d0f040403020106302b06"
    "03551d1104243022861575726e3a494e474f5043533a6c6f63616c686f737482096c6f63616c686f7374302c060960"
    "86480186f842010d041f161d4f70656e53534c2047656e657261746564204365727469666963617465300d06092a86"
    "4886f70d01010b0500038201010053e982480661e4bffb4af3f1b37d663e4191a3b0cfb590e9f50008634c63d3b442"
    "97b7544dee44f103f589c15f59b080e037603309e0afe6b9d294f61ad85f5de27275983d6d81353e97dfc30bbbcc3b"
    "359a8720206bc298bc9f0da97a4dbd24c0c07a9607071c3d729ad2849ee0c3d2b410ee9e066aef3a9bf3e755f19270"
    "808c5efbaf46a8c8ca7d290162a818c1e6abba08c973e4d6857487a62e0a34a61930150e2e2639fc5ec8234f5a86a3"
    "8bd9e7454f8157732f6028adbcb1525770671c0443724270d4bf8fa530193e033712a2e2f2b8581d3dcaa974cb3504"
    "c475582322b8f0ffb212a714fea2b6016eb928ef523ec65f0b160063ba207c45caa2d7";

// cacert.der
static const char* CRT_NO_URI =
    "308203f5308202dda003020102020900ccd2d9ade3419143300d06092a86"
    "4886f70d01010b0500308188310b3009060355040613024652310c300a06"
    "035504080c03494446310e300c06035504070c0550415249533110300e06"
    "0355040a0c07494e474f5043533110300e060355040b0c07494e474f5043"
    "533113301106035504030c0a494e474f5043532043413122302006092a86"
    "4886f70d0109011613696e676f70637340737973746572656c2e6672301e"
    "170d3137303932373135353032355a170d3138303932373135353032355a"
    "308188310b3009060355040613024652310c300a06035504080c03494446"
    "310e300c06035504070c0550415249533110300e060355040a0c07494e47"
    "4f5043533110300e060355040b0c07494e474f5043533113301106035504"
    "030c0a494e474f5043532043413122302006092a864886f70d0109011613"
    "696e676f70637340737973746572656c2e667230820122300d06092a8648"
    "86f70d01010105000382010f003082010a02820101009b3ba50f9a27b273"
    "70513de979667a3a4b24b3cc0fbd90fb03c6b19395a7a11eadc6aefeab54"
    "cb9c863c9b52eb8a48cd187c02b598f2e8d611ef56c18009701e480f4bcd"
    "fba3a339d79453fb0897b89e20f5ae5381f2a0bda97599c5e4167d243b03"
    "caa5b4bc7a05a424e2176ea04b2ef71ac273b20bd7c727e1a716f07e4ec1"
    "251debc6c98409c8eafa16c05254495a7833bee269aa0fdb4c98e30fef23"
    "45afa65d1630e657e6a4c10ab51b9c34a4ddbd0e7090984859bb2565b3fd"
    "10497ede6274ee7968a3bfc503a6f380e292a4c46f2e37e01a89dbd5af6e"
    "9af7f9fb34bbda53e62a87a0427823c4866e5877d5c2660d6cd2649ccbd5"
    "7265e6b56c1ad2570203010001a360305e301d0603551d0e0416041431ae"
    "8e65336406e4379b518fc3379dce459bb61f301f0603551d230418301680"
    "1431ae8e65336406e4379b518fc3379dce459bb61f300f0603551d130101"
    "ff040530030101ff300b0603551d0f040403020106300d06092a864886f7"
    "0d01010b050003820101004edb4347e6ae979f1df03965bf831d3e70de12"
    "3b8dbd93c0a262347948b25ba93ab893f26f229c41485198f2f6e4bcb523"
    "6516906318e3e00555ba11f27343e689078d87fda403b94f54cbe12fa50e"
    "ecb98af0030519260bd5cba4fef5254087ad8cd63306d481ca3bb883587e"
    "1bb2f23bd2b8e9e0c434a140bdba510099e6d64adbb58628bbca257785f7"
    "2db559dbf291fd6c43a5701f63d7805d705b3387cb032724cb8e0e949b9d"
    "c376e730a2d977c3838bcea74ee9ed2b6997ae0f2dd268ced21cd1d69848"
    "1f56b3206721a5937cceb5a79241335a259d49d38b550e3990170781d5b6"
    "d6817476c9389f75293254515b64a9419d6e1cda971d79578906ce";

static SOPC_Certificate* unpack_certificate(const char* hex_data)
{
    size_t der_len = strlen(hex_data) / 2;
    uint8_t* der_data = calloc(der_len, sizeof(uint8_t));
    ck_assert_ptr_nonnull(der_data);

    ck_assert(unhexlify(hex_data, der_data, der_len) == (int) der_len);
    SOPC_Certificate* crt = NULL;
    ck_assert(der_len <= SIZE_MAX);
    ck_assert_uint_eq(SOPC_STATUS_OK, SOPC_KeyManager_Certificate_CreateFromDER(der_data, (uint32_t) der_len, &crt));
    free(der_data);

    return crt;
}

START_TEST(test_crypto_check_app_uri)
{
    SOPC_Certificate* crt_uri = unpack_certificate(CRT_URI);
    ck_assert(SOPC_KeyManager_Certificate_CheckApplicationUri(crt_uri, "urn:INGOPCS:localhost"));
    ck_assert(!SOPC_KeyManager_Certificate_CheckApplicationUri(crt_uri, "urn:INGAPCS:localhost"));
    SOPC_KeyManager_Certificate_Free(crt_uri);

    SOPC_Certificate* crt_no_uri = unpack_certificate(CRT_NO_URI);
    ck_assert(!SOPC_KeyManager_Certificate_CheckApplicationUri(crt_no_uri, "urn:INGOPCS:localhost"));
    SOPC_KeyManager_Certificate_Free(crt_no_uri);
}
END_TEST

Suite* tests_make_suite_crypto_tools(void)
{
    Suite* s = suite_create("Crypto tools test");
    TCase* tc_check_app_uri = tcase_create("Check application URI");
    tcase_add_test(tc_check_app_uri, test_crypto_check_app_uri);
    suite_add_tcase(s, tc_check_app_uri);

    return s;
}
